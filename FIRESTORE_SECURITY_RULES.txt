===========================================
FIRESTORE SECURITY RULES
===========================================

Copy and paste these rules into your Firebase Console:
Firebase Console → Firestore Database → Rules

-------------------------------------------

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is global admin
    function isGlobalAdmin() {
      return request.auth != null && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isGlobalAdmin == true;
    }
    
    // Helper function to get user data
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // Users collection
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        (request.auth.uid == userId || isGlobalAdmin());
    }
    
    // Invites collection
    match /invites/{inviteId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && isGlobalAdmin();
      allow update: if request.auth != null && isGlobalAdmin();
      allow delete: if request.auth != null && isGlobalAdmin();
    }
    
    // Stores collection
    match /stores/{storeId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && isGlobalAdmin();
      allow update: if request.auth != null && isGlobalAdmin();
      allow delete: if request.auth != null && isGlobalAdmin();
    }
    
    // Businesses collection
    match /businesses/{businessId} {
      // Read: Allow if authenticated (app enforces store-based filtering in queries)
      allow read: if request.auth != null;
      
      // Create: Must set storeId and createdBy, app enforces store access
      allow create: if request.auth != null && 
        request.resource.data.storeId != null &&
        request.resource.data.createdBy == request.auth.uid;
      
      // Update: Must be creator or global admin, storeId cannot be removed
      allow update: if request.auth != null && 
        (resource.data.createdBy == request.auth.uid || isGlobalAdmin()) &&
        request.resource.data.storeId != null;
      
      // Delete: Must be creator or global admin
      allow delete: if request.auth != null && 
        (resource.data.createdBy == request.auth.uid || isGlobalAdmin());
    }
    
    // Contacts collection
    match /contacts/{contactId} {
      // Read: Allow if authenticated (app enforces store-based filtering in queries)
      allow read: if request.auth != null;
      
      // Create: Must set storeId and createdBy, app enforces store access
      allow create: if request.auth != null && 
        request.resource.data.storeId != null &&
        request.resource.data.createdBy == request.auth.uid;
      
      // Update: Must be creator or global admin, storeId cannot be removed
      allow update: if request.auth != null && 
        (resource.data.createdBy == request.auth.uid || isGlobalAdmin()) &&
        request.resource.data.storeId != null;
      
      // Delete: Must be creator or global admin
      allow delete: if request.auth != null && 
        (resource.data.createdBy == request.auth.uid || isGlobalAdmin());
    }
    
    // Calendar Events collection
    match /calendarEvents/{eventId} {
      // Read: Allow if authenticated (app enforces store-based filtering in queries)
      allow read: if request.auth != null;

      // Create: Must set storeId and createdBy, app enforces store access
      allow create: if request.auth != null &&
        request.resource.data.storeId != null &&
        request.resource.data.createdBy == request.auth.uid;

      // Update: Must be creator or global admin, storeId cannot be removed
      allow update: if request.auth != null &&
        (resource.data.createdBy == request.auth.uid || isGlobalAdmin()) &&
        request.resource.data.storeId != null;

      // Delete: Must be creator or global admin
      allow delete: if request.auth != null &&
        (resource.data.createdBy == request.auth.uid || isGlobalAdmin());
    }

    // API Keys collection - CRITICAL: Only server-side access via Firebase Admin SDK
    // These rules prevent client-side access, but serverless functions use Admin SDK which bypasses rules
    // The Admin SDK has full access, so we rely on server-side code security
    match /apiKeys/{keyId} {
      // Deny all client-side access - API keys should ONLY be accessed via serverless functions
      // Serverless functions use Firebase Admin SDK which bypasses these rules
      allow read: if false; // No client-side reads
      allow write: if false; // No client-side writes
      
      // Note: Serverless functions using Firebase Admin SDK can read/write regardless of these rules
      // This is intentional - only server-side code should access API keys
    }
  }
}

-------------------------------------------
SETUP INSTRUCTIONS:
-------------------------------------------

1. Go to Firebase Console → Firestore Database
2. Click on the "Rules" tab
3. Replace all existing rules with the rules above
4. Click "Publish"

IMPORTANT NOTES:
- Global admins can manage all collections
- Regular users can only modify their own created documents
- All businesses and contacts must have a storeId (enforced at rule level)
- Store-based access control is enforced by the application (queries filter by storeId)
- Users can only create businesses/contacts with storeId set (app validates user has access to that store)